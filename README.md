# clue

Here are a couple of scripts to generate efficient, robust, and low batch effect designs for pooled single cell experiments with multiple individuals.

## Example

```
python robust_design_automized.py  -o ./ -N 20 -C 3 -m 4 --max_seconds 20
```

The above command generates a design with 20 donors, each with 3 samples from 3 different experimental conditions. The result satisfies the condition that each pair of donors differ by 4 pools, so we guarantee full recovery of the donor identities unless 4 or more pools fail. This generates the design as in `./example/N20_P12_C3_m4.design`

The minimal inputs are -N and -C

When -P is not present, the algorithm decides the minimum number of pools needed automatically. Outputs are written to the current directory by default.

For example
```
python robust_design_automized.py -N 20 -C 3
```
generates the design as in `./example/N20_P6_C3_m2.design`, that is maximally compact though not quite robust (`m2` means the most similar pair of donors differs only by 2 pools (i.e. co-exiting in 2 pools and differing in the third), which is the worst case).

## General usage

-o/--path: Prefix of the output

-N/--indiv: Number of individuals (required)

-C/-conditions": Number of experimental conditions (required)

-P/--pools: Fixed number of pools

-m/--min_dist: Robust parameter: minimum number of pairwise distance between individual profiles

-t/--max_threads: Number of threads to use

--Gurobi: If the Gurobi solver set up in the system adding this option speeds up optimization

--max_seconds: Maximum seconds to run optimization in each ILP

## Output
`./example` contains example output

For each design, e.g. `N64_P11_C6_m4` (a robust design for 64 donors in 6 experimental conditional using 11 pools, generated by -N 64 -C 6 -m 4), there are two files

- `N64_P11_C6_m4.design` contains the design matrix. Each row is one pool, each column is one donor. Each letter indicates one experimental condition, here coded from a to f, "." indicates the donor is not loaded in the corresponding pool
```
. . . . . . . . . . . . . . . . . . . . . . . . . . . . e c b d e d a b d c a f a f b c e d e d c f e f e b f a a b b c c f d a
. . . . . . . . . . e d b a a c b d b c f d e b f a c c . . . . . . . . . . . . . . . . . . c c b b f e d d a f d e a e f a e f
. . . . a f e f e f . . . . . . . . d e c f d a c c b a . . . . . . . . b d f d b a c e b e . . . . . . . . . . b c e a d b f c
. e c f . . d a a c . . . b e d f b . . . . . d b f d b . . . c c a d a . . . . . e e f a b . . . . . b f c c e . . . . . e a d
e . b a c c . . f a . f a . . b d a . . d a c . . . e f . b e . . f b d . . d e f . . . c c . . f a d . . . e b . . . d b . . e
d a . e . b . c . b . a f e d . . f c a . . a . . d . e f . f . b . e c . b . c d . f b . . a a . . b . . e . d . . d . e . c .
c . f d . a a b b . b . c f f . c . . b e e . . a . . d d e . b d . . e f . c . e . . d . a . b . e c . a . d . . f f . . c . .
. d a c f d b . . e a e d . b e . . f . . c . . d b f . b d c e . . f . . a b . . c . a f . . e d . . c . f b . c a . . a . . .
a c e . e e f d . . d c . . c . a e a d b . . f . . a . a f . . f c c . c e . b . d . . . f f . e . a d b . . . . d . b . . b .
f b d . b . . e d d f . e d . f . c e . a . f c e . . . c . a a . b . f e . e a . b d . . . b . a c . . c a . . f . c . . . . b
b f . b d . c . c . c b . c . a e . . f . b b e . e . . . a d f a e . . a f . . c . a . d . d f . d . a . . . c e . . f . d . .
```


- `N64_P11_C6_m4.txt` contains more details about the property of this design.
```
Spectrum of pairwise overlap:

0:0     1:0     2:465   3:621   4:930   5:0
```
This section characterizes the "robustness". It says that 465 donor pairs (among $\binom{64}{2}$) co-exist in only 2 pools, they are the least likely to be mistaken for each other; no two donors co-exist in 5 pools (each of donor has to be loaded in 6 pools because there are 6 samples under different experimental conditions), so all donors identity can be recovered unless 4 out of the 11 pools fail. For analysis of robustness under noisy identity recovery see `Robustness.ipynb`.

```
Number of occurrences in each pool:

Pool    a       b       c       d       e       f
0       6       6       6       6       6       6
1       6       6       6       6       6       6
2       5       6       6       5       6       6
3       6       6       6       6       6       5
4       6       6       5       6       6       6
5       6       6       5       6       6       5
6       5       6       6       6       6       6
7       6       6       6       6       5       6
8       6       5       6       6       6       6
9       6       6       6       5       6       6
10      6       5       6       6       5       6
```
This section shows how many samples of each experimental condition are assigned to each pool. Each column is one condition (labeled as a to f), each row is one pool. We try to balance the conditions over the pools to minimize batch effect, as in here all pools have roughly the same composition.


## Reproducible scripts

`Decode.ipynb` shows how to recover the donor identity based on the experimental design and the cell identities assigned by freemuxlet

`Robustness.ipynb` shows how different designs behave when genotype based identity recovery contains noise

`GraphDemo.ipynb` generates the toy example used in Figure 1 and S1 in the paper
